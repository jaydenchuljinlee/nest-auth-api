# ðŸ“˜ NestJSì—ì„œ HttpOnly ì¿ í‚¤ ê¸°ë°˜ RefreshToken + Logout í•™ìŠµ ë¬¸ì„œ

## 1. HttpOnly ì¿ í‚¤ ê¸°ë°˜ RefreshToken ì „ëžµ
- localStorageì— ì €ìž¥í•˜ëŠ” ë°©ì‹ë³´ë‹¤ XSS ê³µê²©ì— ê°•í•¨
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ document.cookieë¡œ ì ‘ê·¼ ë¶ˆê°€ëŠ¥ â†’ ë³´ì•ˆì„± í–¥ìƒ

> ë°œê¸‰ íë¦„ ìš”ì•½
| ë‹¨ê³„                                       | ì„¤ëª…                                                    |
| ---------------------------------------- | ----------------------------------------------------- |
| ë¡œê·¸ì¸                                      | accessTokenì€ JSONìœ¼ë¡œ ë°˜í™˜, refreshTokenì€ HttpOnly ì¿ í‚¤ë¡œ ì „ì†¡ |
| AccessToken ë§Œë£Œ                           | í´ë¼ì´ì–¸íŠ¸ê°€ `/auth/refresh` ìš”ì²­ (ì¿ í‚¤ ìžë™ í¬í•¨ë¨)                 |
| ì„œë²„ëŠ” refreshToken ì¿ í‚¤ í™•ì¸ í›„ accessToken ìž¬ë°œê¸‰ |                                                       |
| ë¡œê·¸ì•„ì›ƒ ì‹œ refreshToken ì¿ í‚¤ ì‚­ì œ                |                                                       |

---

## 2. ì‚¬ìš©ëœ ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬

| ë¼ì´ë¸ŒëŸ¬ë¦¬                  | ì„¤ëª…                                                           |
| ---------------------- | ------------------------------------------------------------ |
| `cookie-parser`        | Expressì˜ ìš”ì²­ì—ì„œ ì¿ í‚¤ë¥¼ íŒŒì‹±í•´ì„œ `req.cookies`ì— ë‹´ì•„ì£¼ëŠ” ë¯¸ë“¤ì›¨ì–´              |
| `@types/cookie-parser` | TypeScriptì—ì„œ cookie-parser íƒ€ìž… ì§€ì›ì„ ìœ„í•œ íŒ¨í‚¤ì§€                     |
| `express`              | NestJSëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Express ìœ„ì—ì„œ ë™ìž‘í•˜ë©°, `Response.cookie()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•¨ |


---

## 3. ë¡œê·¸ì¸ ì‹œ RefreshTokenì„ HttpOnly ì¿ í‚¤ë¡œ ì„¤ì •

> auth.controller.ts
```ts
@Post('login')
async login(@Body() loginDto: LoginDto, @Res({ passthrough: true }) res: Response) {
  const user = await this.authService.validateUser(loginDto.email, loginDto.password);
  const { accessToken, refreshToken } = await this.authService.login(user);

  res.cookie('refresh_token', refreshToken, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 7 * 24 * 60 * 60 * 1000, // 7ì¼
  });

  return { accessToken };
}
```

## 4. RefreshTokenìœ¼ë¡œ accessToken ìž¬ë°œê¸‰

> auth.controller.ts
```ts
@Post('refresh')
async refresh(@Req() req: Request) {
  const token = req.cookies?.refresh_token;
  if (!token) throw new UnauthorizedException('Refresh token missing');

  try {
    const payload = this.jwtService.verify(token);
    const accessToken = this.jwtService.sign({ sub: payload.sub, email: payload.email }, { expiresIn: '15m' });
    return { accessToken };
  } catch {
    throw new UnauthorizedException('Invalid refresh token');
  }
}
```

## 5. ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬: ì¿ í‚¤ ì‚­ì œ

> auth.controller.ts

```ts
@Post('logout')
logout(@Res({ passthrough: true }) res: Response) {
  res.clearCookie('refresh_token');
  return { message: 'Logged out' };
}
```