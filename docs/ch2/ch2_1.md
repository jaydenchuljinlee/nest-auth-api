# âœ…  NestJS ì¸ì¦/ì¸ê°€ í•™ìŠµ ë¬¸ì„œ

## ğŸ§© PassportStrategyë€?
- NestJSëŠ” Passport.jsë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ì¦ì„ ì²˜ë¦¬í•œë‹¤.
- PassportStrategyëŠ” Passportì˜ ì „ëµ(Strategy)ì„ NestJSì— ë§ê²Œ í™•ì¥í•œ í´ë˜ìŠ¤

### ê¸°ë³¸ êµ¬ì¡° ì˜ˆì‹œ (jwt.strategy.ts)
```ts
@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(configService: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(), // í—¤ë”ì—ì„œ í† í° ì¶”ì¶œ
      secretOrKey: configService.get('JWT_SECRET'),             // ì‹œí¬ë¦¿ í‚¤
    });
  }

  async validate(payload: any) {
    // payload: JWT ë””ì½”ë”© ê²°ê³¼
    return { userId: payload.sub, email: payload.email };
    // ì´ ê°’ì€ request.userì— ì£¼ì…ë¨
  }
}
```

### JwtStrategyì˜ ì—­í• ê³¼ ì„¤ì •
- super({ ... }) ì—ì„œ í† í° ì¶”ì¶œ ë° ê²€ì¦ ë°©ì‹ ì„¤ì •
- validate()ëŠ” í† í°ì´ ìœ íš¨í•  ë•Œ í˜¸ì¶œë˜ë©°, ë°˜í™˜ê°’ì€ req.userë¡œ ì„¤ì •ë¨

### @UseGuardsì™€ AuthGuard('jwt')ì˜ ì—­í• 
```ts
@UseGuards(AuthGuard('jwt'))
@Get('me')
getProfile(@Request() req) {
  return req.user;
}
```
- `AuthGuard('jwt')`: Passportì— ë“±ë¡ëœ `jwt` ì „ëµì„ ì‚¬ìš©í•´ ì¸ì¦ ìˆ˜í–‰
- ì „ëµ ì„±ê³µ ì‹œ, `JwtStrategy.validate()`ì˜ ë°˜í™˜ê°’ì´ `req.user`ì— ë“¤ì–´ê°
- ì‹¤íŒ¨í•˜ë©´ ìë™ìœ¼ë¡œ 401 Unauthorized ì‘ë‹µ

---

### RolesGuardë€?
- `RolesGuard`ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìê°€ íŠ¹ì • "ì—­í• (role)"ì„ ê°€ì¡ŒëŠ”ì§€ ê²€ì‚¬í•˜ëŠ” <b>ì¸ê°€(Authorization)</b> ë¡œì§

```ts
@Injectable()
export class RolesGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const user = request.user;

    const requiredRoles = this.getRolesFromHandler(context);

    return requiredRoles.includes(user.role);
  }

  private getRolesFromHandler(context: ExecutionContext): string[] {
    return Reflect.getMetadata('roles', context.getHandler()) || [];
  }
}
```

### @Roles ë°ì½”ë ˆì´í„°ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ê¸°
```ts
import { SetMetadata } from '@nestjs/common';

export const Roles = (...roles: string[]) => SetMetadata('roles', roles);

@UseGuards(AuthGuard('jwt'), RolesGuard)
@Roles('admin')
@Get('admin-only')
getAdminResource() {
  return 'ê´€ë¦¬ì ì „ìš© ìì›ì…ë‹ˆë‹¤';
}
```

### íë¦„ ìš”ì•½
| ìˆœì„œ | ì„¤ëª…                                                        |
| -- | --------------------------------------------------------- |
| 1  | í´ë¼ì´ì–¸íŠ¸ê°€ accessTokenì„ `Authorization: Bearer <token>`ìœ¼ë¡œ ì „ì†¡  |
| 2  | `AuthGuard('jwt')`ê°€ í† í°ì„ ì¶”ì¶œí•˜ê³ , `JwtStrategy.validate()` ì‹¤í–‰ |
| 3  | ìœ íš¨í•œ ê²½ìš° `req.user`ì— ê°’ ì„¤ì •ë¨                                  |
| 4  | `RolesGuard`ê°€ ì‹¤í–‰ë˜ì–´ `@Roles()`ì— ì •ì˜ëœ ê°’ê³¼ ì‚¬ìš©ì ê¶Œí•œ ë¹„êµ           |
| 5  | ì¡°ê±´ ë§Œì¡± ì‹œ ì»¨íŠ¸ë¡¤ëŸ¬ ì§„ì…, ì•„ë‹ˆë©´ `403 Forbidden` ì‘ë‹µ                   |

